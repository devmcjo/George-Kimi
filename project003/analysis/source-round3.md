# 3차 소스코드 분석 결과 (교차 검증)

> 분석일: 2026-02-12
> 분석자: George-Kimi
> 방법: 교차 검증 및 누락 항목 확인

---

## 교차 검증 결과 요약

| 검증 항목 | 1차 | 2차 | 3차 | 상태 |
|-----------|-----|-----|-----|------|
| 버퍼 오버플로우 | 5건 | 5건 | 0건 (완화) | ✅ 해소 |
| 정수 오버플로우 | 3건 | 3건 | 1건 | ⚠️ 부분 해소 |
| NULL 포인터 | 2건 | 2건 | 1건 | ⚠️ 부분 해소 |
| 리소스 누수 | 4건 | 4건 | 1건 | ✅ 대부분 해소 |
| 경로 순회 | 3건 | 3건 | 3건 | ❌ 미해소 |
| 명령 인젝션 | 2건 | 2건 | 2건 | ❌ 미해소 |
| **신규 발견** | - | - | 5건 | ⚠️ 추가 발견 |

---

## 신규 발견 취약점 (3차)

### 1. TOCTOU (Time-of-check-time-of-use)
- **위치**: `UpdateChecker.cpp:112`, `UpdateExecutor.cpp:445`
- **설명**: `GetFileAttributesW`로 파일 확인 후, `CopyFileW` 실행까지 시간차가 존재
- **위험도**: 중간
- **공격**: 파일 교체 (심볼릭 링크 공격)

### 2. Thread Safety (DllState)
- **위치**: `DllState.h:45-68`
- **설명**: 다중 멤버 변수(`m_state`, `m_lastError` 등)가 동기화 없이 접근됨
- **위험도**: 중간
- **공격**: 멀티스레드 환경에서 상태 불일치

### 3. Exception Handling 부재
- **위치**: 전체 코드베이스
- **설명**: `try/catch` 블록이 없어 C++ 예외 발생 시 비정상 종료
- **위험도**: 중간

### 4. System32 폭백 취약점
- **위치**: `UpdateChecker.cpp:391`
- **설명**: Public Module인 경우 System32에서 파일을 복사해옴
- **위험도**: 중간
- **공격**: Public Module로 등록된 악성 파일이 System32에서 로드됨

### 5. 경쟁 조건 (MoveFileW)
- **위치**: `UpdateExecutor.cpp:280`
- **설명**: 임시 파일을 최종 위치로 이동 시 경쟁 조건 가능성
- **위험도**: 낮음

---

## 취약점 해소 현황

### ✅ 완전 해소 (9건)
- `strcpy` → `StringCchCopyW`
- `sprintf` → `StringCchPrintfW`
- `strcat` → `StringCchCatW`
- 버퍼 크기 검증 추가
- `SecureBuffer` RAII 패턴 도입
- `goto` 제거 (구조화된 코드)
- `WinExec` → `CreateProcessW`
- `TerminateThread` 제거
- 서명 검증 시 `WinVerifyTrust` 결과 실제 확인

### ⚠️ 부분 해소 (4건)
- 정수 오버플로우: 일부만 검증
- NULL 포인터: 주요 함수만 검증
- 리소스 누수: 대부분 해소, 일부 잔존
- FakeSSL: 구조는 유지하나 TLS 병행

### ❌ 미해소 (12건)
- 경로 순회 (3건)
- 명령 인젝션 (2건)
- 하드코딩 키 미이관 (1건)
- 자체 무결성 검증 없음 (1건)
- 다운그레이드 방지 없음 (1건)
- 재생 공격 방지 없음 (1건)
- 업데이트 원자성 없음 (1건)
- TOCTOU (1건)
- Thread Safety (1건)

---

## Alice 계획 vs 실제 구현 비교

| 계획 항목 | 계획 | 실제 | 일치율 |
|-----------|------|------|--------|
| **Phase 1** (기반 모듈) | 완료 | 완료 | 100% |
| **Phase 2** (설정 파싱) | 완료 | 완료 | 95% (경로 검증 누락) |
| **Phase 3** (네트워크) | 완료 | 완료 | 80% (curl 폰백 누락) |
| **Phase 4** (암호화) | 완료 | 부분 | 60% (KeyStore 미완료) |
| **Phase 5** (업데이트) | 완료 | 완료 | 85% (보안 검증 미흡) |
| **Phase 6** (EXE) | 완료 | 완료 | 90% |
| **Phase 7** (검증) | 완료 | 부분 | 70% (통합 테스트 미흡) |
| **Phase 8** (DLL) | 2차 목표 | 미구현 | 0% |

### 종합 일치율: **75%**

---

## 최종 점수 (3차 검토 후)

| 모듈 | 코드 품질 | 기능 완성도 | 보안성 | 총점 | 등급 |
|------|-----------|-------------|--------|------|------|
| Config | 22/25 | 20/25 | - | 42/50 | B+ |
| Network | 18/25 | 18/25 | 12/25 | 48/75 | C+ |
| Security | 22/25 | 18/25 | 15/25 | 55/75 | C+ |
| Update | 19/25 | 18/25 | 10/25 | 47/75 | C |
| Exe/Dll | 18/25 | 22/25 | 15/25 | 55/75 | C+ |

### 평균 총점: **49.4/75 (65.9%)**
### 등급: **C+ (보통)**

---

## 주요 권고사항 (최종)

### 즉시 수정 필요 (Critical)
1. **MupClient 버퍼 오버플로우**: `reqPathA` 길이 검증 추가
2. **ActionRunner 명령 인젝션**: `dllPath` 따옴표 이스케이프
3. **KeyStore 실제 키 이관**: TODO 완료

### 단기 수정 필요 (High)
4. 경로 순회 방지를 위한 `PathCanonicalizeW` 적용
5. TOCTOU 방지를 위한 파일 핸들 기반 작업
6. DllState 멤버 변수 동기화

### 중기 개선 권장 (Medium)
7. 예외 처리 구조 도입
8. 자체 무결성 검증 구현
9. 다운그레이드/재생 공격 방지 메커니즘

---

*3차 분석 완료: 2026-02-12*